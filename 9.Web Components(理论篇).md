### Web Components 核心技术笔记

#### 1. 三大技术支柱

Web Components 并不是一个单一的 API，而是由三项原生技术组合而成的：

- **Custom Elements (自定义元素):** 允许开发者定义新的 HTML 标签及其行为（继承自 `HTMLElement`）。
- **Shadow DOM (影子 DOM):** 提供**封装性**。组件内部的结构和样式与外部完全隔离，互不干扰。
- **HTML Templates (模板):** 使用 `<template>` 和 `<slot>` 定义不随页面加载直接渲染的结构，支持内容分发。

------

#### 2. 深入理解 `HTMLElement` 与 `this`

在 Web Components 的类定义中，`this` 是理解一切的关键。

- **`this` 的身份：** 它就是**组件实例本身**，也是一个真实的 DOM 节点。
- **属性操作：** 可以通过 `this.getAttribute()` 获取标签属性，或通过 `this.innerHTML` 修改内容。
- **数据挂载：** 可以在 `this` 上直接绑定自定义属性（如 `this.count = 0`），使其成为组件的状态中心。

------

#### 3. 组件生命周期 (Lifecycle)

原生 API 提供了四个关键钩子，用于精准控制组件行为：

| **钩子函数**                 | **触发时机**      | **核心用途**                                      |
| ---------------------------- | ----------------- | ------------------------------------------------- |
| `constructor()`              | 实例创建时        | 初始化 `Shadow DOM`，设置初始数据。               |
| `connectedCallback()`        | 元素插入 DOM 时   | **最常用**。用于渲染 UI、绑定事件、发起网络请求。 |
| `disconnectedCallback()`     | 元素从 DOM 移除时 | 清理定时器、解绑全局事件（防止内存泄漏）。        |
| `attributeChangedCallback()` | 监听的属性变化时  | 配合 `observedAttributes` 实现响应式 UI 更新。    |

------

#### 4. 封装与通信 (Encapsulation & Communication)

### 样式隔离 (Shadow DOM)

- **`attachShadow({ mode: 'open' })`**: 开启隔离。
- **样式保护：** 组件内的 CSS 只在 `shadowRoot` 内生效。
- **`:host` 选择器：** 用于从组件内部修改组件自身的样式。
- **`::slotted` 选择器：** 专门用于给通过 `<slot>` 传进来的外部内容设置样式。

### 组件通信

1. **父 -> 子 (Props):** 通过 HTML 属性或直接修改 DOM 对象的属性（`el.value = 123`）。
2. **子 -> 父 (Events):** 使用自定义事件 `this.dispatchEvent(new CustomEvent('name', { detail: data }))`。

------

#### 5. 实现“原生”双向绑定 (v-model)

虽然原生没有 `v-model` 指令，但可以通过以下逻辑模拟：

1. **数据层 (Proxy):** 使用 `Proxy` 拦截 JS 对象的变化，并在 `set` 钩子里手动修改 DOM。
2. **视图层 (Event):** 监听组件内部的 `input` 或 `change` 事件，在回调里更新 JS 对象。
3. **闭环：** `数据变 -> 触发 Proxy -> 修改 DOM` + `用户操作 -> 触发事件 -> 修改数据`。

------

#### 6. 开发建议与避坑指南

- **`this` 指向丢失：** 在 `setTimeout` 或普通回调函数中，`this` 可能会指向 `window`。**务必使用箭头函数**来锁定 `this` 指向组件实例。
- **内存清理：** 在 `disconnectedCallback` 中一定要手动解绑在 `window` 或 `body` 上挂载的事件，否则组件销毁后，事件监听器依然常驻内存。
- **SEO 与 SSR：** Shadow DOM 默认对搜索引擎不友好。如果需要 SEO，应考虑使用 **Declarative Shadow DOM**。

------

#### 🚀 总结

Web Components 是 **“一次编写，到处运行”** 的终极方案。它不依赖 React/Vue 的运行时，性能极高且样式绝对隔离。它是构建企业级通用 UI 组件库（Design System）的首选技术